{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\controller\\websocket.js"
    ],
    "names": [
        "Base",
        "require",
        "socketObject",
        "module",
        "exports",
        "findGroups",
        "user_email",
        "data",
        "model",
        "where",
        "group_id",
        "select",
        "openAction",
        "user",
        "session",
        "think",
        "isEmpty",
        "console",
        "log",
        "Object",
        "assign",
        "websocket",
        "id",
        "emit",
        "groups",
        "map",
        "n",
        "join",
        "closeAction",
        "chatAction",
        "to",
        "wsData",
        "sendTo",
        "toUser",
        "email",
        "sendObj",
        "push",
        "isOnline",
        "fromUser",
        "date",
        "time",
        "toGroup",
        "ctx",
        "app",
        "io",
        "in",
        "addVerifyAction",
        "toEmail",
        "addFriendAction",
        "max",
        "userA",
        "userB",
        "a",
        "friend_email",
        "b",
        "addMany",
        "length",
        "index",
        "Date",
        "dateStr",
        "getFullYear",
        "getMonth",
        "getDate",
        "timeStr",
        "getHours",
        "getMinutes",
        "getSeconds",
        "type",
        "addGroupAction",
        "group",
        "add",
        "dataisExist",
        "inviteToGroupAction",
        "leader",
        "acceptInviteAddToGroupLeaderAction",
        "acceptInviteAddToGroupAction",
        "createGroupJoinAction",
        "result",
        "removeGroupAction",
        "members",
        "leave",
        "delete",
        "leaveGroupAction"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\api\\controller\\websocket.js",
    "sourcesContent": [
        "const Base = require('./base.js');\r\nconst socketObject = {}\r\n// this.websocket是指客户端的socket\r\n// this就是this.websocket\r\n// 所有的socket怎么得？\r\n// 不用获得所有socket的方法是将每个连上的socket放入socketMap\r\n// 发送数据到别的客户端可以用this.websocket.emit\r\nmodule.exports = class extends Base {\r\n\r\n  async findGroups(user_email) {\r\n  \tconst data = await this.model('relationship').where({user_email:user_email,group_id:['!=',null]}).select()\r\n  \treturn data\r\n  }\r\n \r\n  async openAction() {\r\n  \t// 获取用户邮箱\r\n  \tconst user = await this.session('user_token');\r\n  \tif(think.isEmpty(user)){\r\n      return ;\r\n    }\r\n  \tconsole.log('user email: ' + user.user_email)\r\n\r\n  \t// 写入对象，email对应socket本身\r\n  \tObject.assign(socketObject, {[user.user_email]:this.websocket})\r\n\r\n  \tconsole.log(`socketId: ${this.websocket.id}连接`)\r\n  \tthis.emit('opend', 'This client opened successfully!')\r\n  \tconst groups = await this.findGroups('1641084984@qq.com')\r\n  \tgroups.map((n) => {\r\n  \t  this.websocket.join(n.group_id);\r\n  \t})\r\n  \t\r\n  \t// this.websocket.emit('opend', 'This client opened successfully!')\r\n  \t// socketMap.get(this.websocket.id).emit('opend', 'This client opened successfully!')\r\n  }\r\n\r\n  // async storeSocketAction() {\r\n  // \tconsole.log(this.wsData.email)\r\n  // }\r\n\r\n  async closeAction() {\r\n  \tthis.emit('closed','close')\r\n  }\r\n\r\n  async chatAction() {\r\n  \t// 要发送的信息\r\n  \t// 离线消息放入redis？\r\n//   \tconst sseett = [1,2,{aa:'12'}]\r\n//   \tawait think.cache('aaa', sseett);\r\n//   \tlet aaa = await think.cache('aaa');\r\n//   \tconsole.log(aaa)\r\n//   \tsseett.push({aa:'13'})\r\n//   \tawait think.cache('aaa', sseett);\r\n// aaa = await think.cache('aaa');\r\n  \t// await think.cache('aaa').then((data)=> {\r\n  \t//   console.log(data)\r\n  \t// })\r\n  // \tif(this.wsData.file) {\r\n  // \t  var myArray = new ArrayBuffer(512);\r\n\t //  var longInt8View = new Uint8Array(myArray);\r\n\t //  for (var i=0; i< longInt8View.length; i++) {\r\n\t\t// longInt8View[i] = i % 255;\r\n\t //  }\r\n  // \t}\r\n  \tlet to = ''\r\n  \tif(this.wsData.sendTo.toUser) {\r\n  \t  to = this.wsData.sendTo.toUser.email\r\n  \t  // if(socketObject[to]) {\r\n  \t  \tconst sendObj = {}\r\n  \t  \tconst data = []\r\n  \t  \tdata.push({\r\n  \t  \t  isOnline: 1,\r\n  \t  \t  fromUser: this.wsData.fromUser,\r\n  \t  \t  data: this.wsData.data,\r\n  \t  \t  date: this.wsData.date,\r\n  \t  \t  time: this.wsData.time,\r\n  \t  \t  // file: this.wsData.file,\r\n  \t  \t})\r\n  \t  \tObject.assign(sendObj,{id:to},{data:data})\r\n  \t  \tthis.emit('message',{sendObj})\r\n  \t  \tObject.assign(sendObj,{id:this.wsData.fromUser.email})\r\n  \t  \tsocketObject[to].emit('message', {sendObj} )\r\n  \t  // }\r\n  \t}\r\n  \telse {\r\n  \t  to = this.wsData.sendTo.toGroup.id\r\n  \t  // if(socketObject[to]) {\r\n  \t  \tconst sendObj = {}\r\n  \t  \tconst data = []\r\n  \t  \tdata.push({\r\n  \t  \t  isOnline: 1,\r\n  \t  \t  fromUser: this.wsData.fromUser,\r\n  \t  \t  data: this.wsData.data,\r\n  \t  \t  date: this.wsData.date,\r\n  \t  \t  time: this.wsData.time,\r\n  \t  \t})\r\n  \t  \tObject.assign(sendObj,{id:to},{data:data})\r\n  \t  \tthis.ctx.app.websocket.io.in(to).emit('message', {sendObj});\r\n  \t  // }\r\n  \t}\r\n  \t// const data = this.wsData\r\n\r\n  \t// this.websocket.join('123');\r\n  \t\r\n  \t// this.emit('message', aaa)\r\n    // toSocket.emit('message',data.msg);\r\n  }\r\n\r\n  async addVerifyAction() {\r\n  \t// 收到好友/群组验证\r\n  \tconsole.log('`${this.wsData.fromUser.email}`发出验证数据')\r\n  \tsocketObject[this.wsData.toEmail].emit('getVerify', this.wsData)\r\n  \t// this.emit('getVerify', this.wsData)\r\n  }\r\n\r\n  async addFriendAction() {\r\n    const id = await this.model('relationship').max('id')\r\n    // userA 邀请方\r\n    const userA = this.wsData.userA\r\n    const userB = this.wsData.userB\r\n    const a = Object.assign({},{id:id+1},{user_email:userA.email},{friend_email:userB.email})\r\n    const b = Object.assign({},{id:id+2},{user_email:userB.email},{friend_email:userA.email})\r\n    console.log([a,b])\r\n    const data = await this.model('relationship').addMany([a,b])\r\n\r\n    // 有历史记录\r\n    // 验证信息将变为系统消息\r\n    // const systemMessage = user\r\n    // fs.writeFileSync\r\n    if(data.length < 2) {\r\n      // 回滚\r\n      return false\r\n    }\r\n    // 好友成功\r\n    // this是接受方\r\n    const index = this.wsData.index\r\n    const date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n    this.emit('addFriendResult', Object.assign({},{fromUser:userA},{index:index},{type:3}))\r\n    socketObject[userA.email].emit('addFriendResult', Object.assign({},{fromUser:userB},{date:dateStr},{time:timeStr},{type:0},{data:'接受了您的添加请求并添加您为好友'}))\r\n  }\r\n\r\n  async addGroupAction() {\r\n  \tconst id = await this.model('relationship').max('id')\r\n  \t// userA 申请方\r\n  \t// userB 接受方\r\n  \tconst userA = this.wsData.userA\r\n  \tconst userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n  \tconst data = await this.model('relationship').add({id:id+1,user_email:userA.email,group_id:group.group_id})\r\n  \tconst dataisExist = await this.model('relationship').where({id:id+1}).select()\r\n  \tconsole.log(dataisExist)\r\n  \tif(dataisExist.length <=0)\r\n  \t  return false\r\n\r\n  \tconst index = this.wsData.index\r\n  \tconst date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n  \tthis.emit('addGroupResult', Object.assign({},{fromUser:userA},{index:index},{type:4}))\r\n  \tsocketObject[userA.email].emit('addGroupResult', Object.assign({},{fromUser:userB},{group:group},{date:dateStr},{time:timeStr},{type:0},{data:'接受了您加入群的请求'}))\r\n  \t// join group\r\n  \tsocketObject[userA.email].join(group.group_id);\r\n  }\r\n\r\n  async inviteToGroupAction() {\r\n  \t// userA 发起邀请方\r\n  \t// const userA = this.wsData.userA\r\n  \t// const userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n\r\n  \tsocketObject[group.leader].emit('getVerify',this.wsData)\r\n  \t// socketObject[group.leader].emit(...)\r\n  }\r\n\r\n  async acceptInviteAddToGroupLeaderAction() {\r\n  \t// userA 发起邀请方\r\n  \tconst userA = this.wsData.userA\r\n  \tconst userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n  \tconst index = this.wsData.index\r\n\r\n  \t\r\n  \t\r\n  \t// fromUser是邀请方\r\n  \tsocketObject[group.leader].emit('inviteResult',Object.assign({},{fromUser:userA},{group:group},{index:index},{type:6}))\r\n  \t// 发给userA fromUser是userB userB接受邀请 写data\r\n  \tconst date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n  \tsocketObject[userB.friend_email].emit('inviteResult',Object.assign({},{fromUser:userA},{userB:userB},{group:group},{date:dateStr},{time:timeStr},{type:5}))\r\n  \t// join group\r\n  \t// this.websocket.join(group.id);\r\n  }\r\n\r\n  async acceptInviteAddToGroupAction() {\r\n  \t// userA 发起邀请方\r\n  \tconst userA = this.wsData.userA\r\n  \tconst userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n  \tconst index = this.wsData.index\r\n  \tconsole.log(userB)\r\n\r\n  \tconst id = await this.model('relationship').max('id')\r\n  \tconst data = await this.model('relationship').add({id:id+1,user_email:userB.friend_email,group_id:group.id})\r\n\r\n  \tsocketObject[userB.friend_email].emit('inviteResult',Object.assign({},{fromUser:userA},{group:group},{index:index},{type:6}))\r\n  \tconst date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n  \tsocketObject[userA.email].emit('inviteResult',Object.assign({},{fromUser:userA},{group:group},{userB:userB},{time:timeStr},{date:dateStr},{type:7},{data:'接受了您的请求并加入群'}))\r\n  \t// join group\r\n  \tsocketObject[userB.friend_email].join(group.id);\r\n  }\r\n\r\n  async createGroupJoinAction() {\r\n  \tconst group = this.wsData\r\n  \tconsole.log(`进入房间${group.result[0].group_id}`)\r\n  \tthis.websocket.join(group.result[0].group_id)\r\n  }\r\n\r\n  async removeGroupAction() {\r\n  \tconst group_id = this.wsData.group.id\r\n  \tthis.ctx.app.websocket.io.in(group_id).emit('removeGroup', this.wsData);\r\n  \tconst members = await this.model('relationship').where({group_id:group_id}).select()\r\n  \tawait members.map((n) => {\r\n  \t  if(socketObject[n.user_email])\r\n  \t  \tsocketObject[n.user_email].leave(group_id)\r\n  \t})\r\n  \tawait this.model('relationship').where({group_id:group_id}).delete()\r\n  \tawait this.model('group').where({group_id:group_id}).delete()\r\n  }\r\n\r\n  async leaveGroupAction() {\r\n  \tconst group_id = this.wsData.group.id\r\n  \tthis.websocket.leave(group_id)\r\n  }\r\n};\r\n"
    ]
}
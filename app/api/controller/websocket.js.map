{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\controller\\websocket.js"
    ],
    "names": [
        "Base",
        "require",
        "socketObject",
        "conn",
        "connectmq",
        "then",
        "result",
        "console",
        "log",
        "catch",
        "error",
        "Promise",
        "resolve",
        "reject",
        "amqp",
        "connect",
        "err",
        "module",
        "exports",
        "findGroups",
        "user_email",
        "data",
        "model",
        "where",
        "group_id",
        "select",
        "assertmq",
        "to",
        "createChannel",
        "channel",
        "q",
        "assertQueue",
        "durable",
        "sendToQueue",
        "Buffer",
        "JSON",
        "stringify",
        "persistent",
        "close",
        "createmqchannel",
        "ch",
        "receivemq",
        "email",
        "think",
        "isEmpty",
        "checkQueue",
        "consume",
        "ack",
        "parse",
        "content",
        "noAck",
        "loginAction",
        "wsData",
        "Object",
        "assign",
        "websocket",
        "id",
        "groups",
        "map",
        "n",
        "join",
        "emit",
        "sendObj",
        "closeAction",
        "emails",
        "keys",
        "index",
        "findIndex",
        "value",
        "is",
        "undefined",
        "chatAction",
        "sendTo",
        "toUser",
        "push",
        "isOnline",
        "fromUser",
        "date",
        "time",
        "toGroup",
        "ctx",
        "app",
        "io",
        "in",
        "addVerifyAction",
        "toEmail",
        "addFriendAction",
        "max",
        "userA",
        "userB",
        "a",
        "friend_email",
        "b",
        "addMany",
        "length",
        "Date",
        "dateStr",
        "getFullYear",
        "getMonth",
        "getDate",
        "timeStr",
        "getHours",
        "getMinutes",
        "getSeconds",
        "type",
        "addGroupAction",
        "group",
        "add",
        "dataisExist",
        "inviteToGroupAction",
        "leader",
        "acceptInviteAddToGroupLeaderAction",
        "acceptInviteAddToGroupAction",
        "createGroupJoinAction",
        "removeGroupAction",
        "members",
        "leave",
        "delete",
        "leaveGroupAction"
    ],
    "mappings": "AACA;;;;;;;;AADA,MAAMA,OAAOC,QAAQ,WAAR,CAAb;;AAEA,MAAMC,eAAe,EAArB;AACA,IAAIC,OAAO,EAAX;AACAC,YAAYC,IAAZ,CAAkBC,MAAD,IAAY;AACvBH,SAAOG,MAAP;AACAC,UAAQC,GAAR,CAAY,OAAZ;AACD,CAHL,EAGOC,KAHP,CAGcC,KAAD,IAAWH,QAAQC,GAAR,CAAYE,KAAZ,CAHxB;;AAKA,SAASN,SAAT,GAAqB;AACjB,SAAO,IAAIO,OAAJ,CAAY,CAACC,OAAD,EAASC,MAAT,KAAoB;AACrCC,2BAAKC,OAAL,CAAa,kBAAb,EAAiC,UAAUC,GAAV,EAAeb,IAAf,EAAqB;AACpD,UAAGa,GAAH,EACEH,OAAOG,GAAP,EADF,KAGEJ,QAAQT,IAAR;AACF,KALF;AAMD,GAPM,CAAP;AAQD;AACH;AACA;AACA;AACA;AACA;AACAc,OAAOC,OAAP,GAAiB,cAAclB,IAAd,CAAmB;;AAE5BmB,YAAN,CAAiBC,UAAjB,EAA6B;AAAA;;AAAA;AAC5B,YAAMC,OAAO,MAAM,MAAKC,KAAL,CAAW,cAAX,EAA2BC,KAA3B,CAAiC,EAACH,YAAWA,UAAZ,EAAuBI,UAAS,CAAC,IAAD,EAAM,IAAN,CAAhC,EAAjC,EAA+EC,MAA/E,EAAnB;AACA,aAAOJ,IAAP;AAF4B;AAG5B;;AAGD;;;;;;;;;;;;;;;;;;;;AAoBMK,UAAN,CAAeL,IAAf,EAAoBM,EAApB,EAAwB;AAAA;AACtB,YAAMxB,KAAKyB,aAAL,CAAmB,UAACZ,GAAD,EAAMa,OAAN,EAAkB;;AAEzC,cAAMC,IAAIH,EAAV;;AAEAE,gBAAQE,WAAR,CAAoBD,CAApB,EAAuB,EAAEE,SAAS,IAAX,EAAvB;AACA;AACAH,gBAAQI,WAAR,CAAoBH,CAApB,EAAuB,IAAII,MAAJ,CAAWC,KAAKC,SAAL,CAAef,IAAf,CAAX,CAAvB,EAAyD,EAAEgB,YAAY,IAAd,EAAzD;AACA9B,gBAAQC,GAAR,CAAYa,IAAZ;AACAQ,gBAAQS,KAAR;AACD,OATK,CAAN;AADsB;AAWvB;;AAEKC,iBAAN,GAAwB;AAAA;AACtB,aAAO,IAAI5B,OAAJ,CAAY,UAACC,OAAD,EAASC,MAAT,EAAoB;AACrCV,aAAKyB,aAAL,CAAmB,UAACZ,GAAD,EAAKwB,EAAL,EAAY;AAC7B;AACA;AACA;AACE5B,kBAAQ4B,EAAR;AACH,SALD;AAMD,OAPM,CAAP;AADsB;AASvB;;AAIKC,WAAN,CAAgBC,KAAhB,EAAuB;AAAA;;AAAA;AACrB,YAAMb,UAAU,MAAM,OAAKU,eAAL,EAAtB;AACA,UAAGI,MAAMC,OAAN,CAAcf,OAAd,CAAH,EACE;;AAEF,aAAO,IAAIlB,OAAJ,CAAY,UAACC,OAAD,EAASC,MAAT,EAAoB;AACrC,cAAMiB,IAAIY,KAAV;AACAb,gBAAQgB,UAAR,CAAmBf,CAAnB;AACED,gBAAQE,WAAR,CAAoBD,CAApB,EAAuB,EAACE,SAAS,IAAV,EAAvB;AACAH,gBAAQiB,OAAR,CAAgBhB,CAAhB,EAAmB,UAACT,IAAD,EAAU;AAC3BQ,kBAAQkB,GAAR,CAAY1B,IAAZ;AACAT,kBAAQuB,KAAKa,KAAL,CAAW3B,KAAK4B,OAAhB,CAAR;AACD,SAHD,EAGG,EAACC,OAAO,KAAR,EAHH;AAIArB,gBAAQS,KAAR;AACH,OATM,CAAP;AALqB;AAetB;;AAGKa,aAAN,GAAoB;AAAA;;AAAA;AACnB;AACC,YAAMT,QAAQ,OAAKU,MAAL,CAAYV,KAA1B;AACD;AACA;;;AAGAnC,cAAQC,GAAR,CAAY,iBAAiBkC,KAA7B;;AAEA;AACAW,aAAOC,MAAP,CAAcpD,YAAd,EAA4B,EAAC,CAACwC,KAAD,GAAQ,OAAKa,SAAd,EAA5B;;AAEAhD,cAAQC,GAAR,CAAa,aAAY,OAAK+C,SAAL,CAAeC,EAAG,IAA3C;AACA;AACA,YAAMC,SAAS,MAAM,OAAKtC,UAAL,CAAgBuB,KAAhB,CAArB;AACAe,aAAOC,GAAP,CAAW,UAACC,CAAD,EAAO;AAChB,eAAKJ,SAAL,CAAeK,IAAf,CAAoBD,EAAEnC,QAAtB;AACD,OAFD;;AAIA,YAAM,OAAKiB,SAAL,CAAeC,KAAf,EACJrC,IADI,CACC,mBAAW;AACfE,gBAAQC,GAAR,CAAYI,OAAZ;AACA,eAAKiD,IAAL,CAAU,SAAV,EAAqB,EAACC,SAAQlD,OAAT,EAArB;AACD,OAJI,EAKJH,KALI,CAKE;AAAA,eAAUF,QAAQC,GAAR,CAAY,OAAZ,CAAV;AAAA,OALF,CAAN;AAMC;AAzBkB;AA0BnB;;AAEKuD,aAAN,GAAoB;AAAA;;AAAA;AAClB,YAAMC,SAASX,OAAOY,IAAP,CAAY/D,YAAZ,CAAf;AACA,YAAMgE,QAAQF,OAAOG,SAAP,CAAiB,UAACC,KAAD;AAAA,eAAWf,OAAOgB,EAAP,CAAUnE,aAAakE,KAAb,CAAV,EAA8B,OAAKb,SAAnC,CAAX;AAAA,OAAjB,CAAd;AACA,UAAGW,UAAU,CAAC,CAAd,EAAiB;AACf3D,gBAAQC,GAAR,CAAa,GAAEwD,OAAOE,KAAP,CAAc,IAA7B;AACAb,eAAOC,MAAP,CAAcpD,YAAd,EAA2B,EAAC,CAAC8D,OAAOE,KAAP,CAAD,GAAgBI,SAAjB,EAA3B;AACD;AANiB;AAOnB;;AAGKC,YAAN,GAAmB;AAAA;;AAAA;AAClB;AACA;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACG;AACA;AACA;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACC,UAAI5C,KAAK,EAAT;AACA,UAAG,OAAKyB,MAAL,CAAYoB,MAAZ,CAAmBC,MAAtB,EAA8B;AAC5B9C,aAAK,OAAKyB,MAAL,CAAYoB,MAAZ,CAAmBC,MAAnB,CAA0B/B,KAA/B;AACA;AACC,cAAMoB,UAAU,EAAhB;AACA,cAAMzC,OAAO,EAAb;AACAA,aAAKqD,IAAL,CAAU;AACRC,oBAAU,IADF;AAERC,oBAAU,OAAKxB,MAAL,CAAYwB,QAFd;AAGRvD,gBAAM,OAAK+B,MAAL,CAAY/B,IAHV;AAIRwD,gBAAM,OAAKzB,MAAL,CAAYyB,IAJV;AAKRC,gBAAM,OAAK1B,MAAL,CAAY0B;AAClB;AANQ,SAAV;AAQAzB,eAAOC,MAAP,CAAcQ,OAAd,EAAsB,EAACN,IAAG7B,EAAJ,EAAtB,EAA8B,EAACN,MAAKA,IAAN,EAA9B;AACA,eAAKwC,IAAL,CAAU,SAAV,EAAoB,EAACC,OAAD,EAApB;AACAT,eAAOC,MAAP,CAAcQ,OAAd,EAAsB,EAACN,IAAG,OAAKJ,MAAL,CAAYwB,QAAZ,CAAqBlC,KAAzB,EAAtB;AACEnC,gBAAQC,GAAR,CAAYmC,MAAMC,OAAN,CAAc1C,aAAayB,EAAb,CAAd,CAAZ;AACA,YAAGgB,MAAMC,OAAN,CAAc1C,aAAayB,EAAb,CAAd,CAAH,EAAoC;AAClC;AACA,iBAAKD,QAAL,CAAcoC,OAAd,EAAsBnC,EAAtB;AACA;AACD;AACHzB,qBAAayB,EAAb,EAAiBkC,IAAjB,CAAsB,SAAtB,EAAiC,EAACC,OAAD,EAAjC;AACD;AACD,OAxBD,MAyBK;AACHnC,aAAK,OAAKyB,MAAL,CAAYoB,MAAZ,CAAmBO,OAAnB,CAA2BvB,EAAhC;AACA;AACC,cAAMM,UAAU,EAAhB;AACA,cAAMzC,OAAO,EAAb;AACAA,aAAKqD,IAAL,CAAU;AACRC,oBAAU,CADF;AAERC,oBAAU,OAAKxB,MAAL,CAAYwB,QAFd;AAGRvD,gBAAM,OAAK+B,MAAL,CAAY/B,IAHV;AAIRwD,gBAAM,OAAKzB,MAAL,CAAYyB,IAJV;AAKRC,gBAAM,OAAK1B,MAAL,CAAY0B;AALV,SAAV;AAOAzB,eAAOC,MAAP,CAAcQ,OAAd,EAAsB,EAACN,IAAG7B,EAAJ,EAAtB,EAA8B,EAACN,MAAKA,IAAN,EAA9B;AACA,eAAK2D,GAAL,CAASC,GAAT,CAAa1B,SAAb,CAAuB2B,EAAvB,CAA0BC,EAA1B,CAA6BxD,EAA7B,EAAiCkC,IAAjC,CAAsC,SAAtC,EAAiD,EAACC,OAAD,EAAjD;AACD;AACD;AA7DiB;AA8DlB;;AAEKsB,iBAAN,GAAwB;AAAA;;AAAA;AACvB;AACA7E,cAAQC,GAAR,CAAY,uCAAZ;AACAN,mBAAa,OAAKkD,MAAL,CAAYiC,OAAzB,EAAkCxB,IAAlC,CAAuC,WAAvC,EAAoD,OAAKT,MAAzD;AACA;AAJuB;AAKvB;;AAEKkC,iBAAN,GAAwB;AAAA;;AAAA;AACtB,YAAM9B,KAAK,MAAM,OAAKlC,KAAL,CAAW,cAAX,EAA2BiE,GAA3B,CAA+B,IAA/B,CAAjB;AACA;AACA,YAAMC,QAAQ,OAAKpC,MAAL,CAAYoC,KAA1B;AACA,YAAMC,QAAQ,OAAKrC,MAAL,CAAYqC,KAA1B;AACA,YAAMC,IAAIrC,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACE,IAAGA,KAAG,CAAP,EAAjB,EAA2B,EAACpC,YAAWoE,MAAM9C,KAAlB,EAA3B,EAAoD,EAACiD,cAAaF,MAAM/C,KAApB,EAApD,CAAV;AACA,YAAMkD,IAAIvC,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACE,IAAGA,KAAG,CAAP,EAAjB,EAA2B,EAACpC,YAAWqE,MAAM/C,KAAlB,EAA3B,EAAoD,EAACiD,cAAaH,MAAM9C,KAApB,EAApD,CAAV;AACAnC,cAAQC,GAAR,CAAY,CAACkF,CAAD,EAAGE,CAAH,CAAZ;AACA,YAAMvE,OAAO,MAAM,OAAKC,KAAL,CAAW,cAAX,EAA2BuE,OAA3B,CAAmC,CAACH,CAAD,EAAGE,CAAH,CAAnC,CAAnB;;AAEA;AACA;AACA;AACA;AACA,UAAGvE,KAAKyE,MAAL,GAAc,CAAjB,EAAoB;AAClB;AACA,eAAO,KAAP;AACD;AACD;AACA;AACA,YAAM5B,QAAQ,OAAKd,MAAL,CAAYc,KAA1B;AACA,YAAMW,OAAO,IAAIkB,IAAJ,EAAb;AACA,YAAMC,UAAUnB,KAAKoB,WAAL,KAAqB,GAArB,IAA4BpB,KAAKqB,QAAL,KAAkB,CAA9C,IAAmD,GAAnD,GAAyDrB,KAAKsB,OAAL,EAAzE;AACA,YAAMC,UAAUvB,KAAKwB,QAAL,KAAkB,GAAlB,GAAwBxB,KAAKyB,UAAL,EAAxB,GAA4C,GAA5C,GAAkDzB,KAAK0B,UAAL,EAAlE;AACA,aAAK1C,IAAL,CAAU,iBAAV,EAA6BR,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACsB,UAASY,KAAV,EAAjB,EAAkC,EAACtB,OAAMA,KAAP,EAAlC,EAAgD,EAACsC,MAAK,CAAN,EAAhD,CAA7B;AACAtG,mBAAasF,MAAM9C,KAAnB,EAA0BmB,IAA1B,CAA+B,iBAA/B,EAAkDR,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACsB,UAASa,KAAV,EAAjB,EAAkC,EAACZ,MAAKmB,OAAN,EAAlC,EAAiD,EAAClB,MAAKsB,OAAN,EAAjD,EAAgE,EAACI,MAAK,CAAN,EAAhE,EAAyE,EAACnF,MAAK,kBAAN,EAAzE,CAAlD;AAzBsB;AA0BvB;;AAEKoF,gBAAN,GAAuB;AAAA;;AAAA;AACtB,YAAMjD,KAAK,MAAM,OAAKlC,KAAL,CAAW,cAAX,EAA2BiE,GAA3B,CAA+B,IAA/B,CAAjB;AACA;AACA;AACA,YAAMC,QAAQ,OAAKpC,MAAL,CAAYoC,KAA1B;AACA,YAAMC,QAAQ,OAAKrC,MAAL,CAAYqC,KAA1B;AACA,YAAMiB,QAAQ,OAAKtD,MAAL,CAAYsD,KAA1B;AACA,YAAMrF,OAAO,MAAM,OAAKC,KAAL,CAAW,cAAX,EAA2BqF,GAA3B,CAA+B,EAACnD,IAAGA,KAAG,CAAP,EAASpC,YAAWoE,MAAM9C,KAA1B,EAAgClB,UAASkF,MAAMlF,QAA/C,EAA/B,CAAnB;AACA,YAAMoF,cAAc,MAAM,OAAKtF,KAAL,CAAW,cAAX,EAA2BC,KAA3B,CAAiC,EAACiC,IAAGA,KAAG,CAAP,EAAjC,EAA4C/B,MAA5C,EAA1B;AACAlB,cAAQC,GAAR,CAAYoG,WAAZ;AACA,UAAGA,YAAYd,MAAZ,IAAqB,CAAxB,EACE,OAAO,KAAP;;AAEF,YAAM5B,QAAQ,OAAKd,MAAL,CAAYc,KAA1B;AACA,YAAMW,OAAO,IAAIkB,IAAJ,EAAb;AACC,YAAMC,UAAUnB,KAAKoB,WAAL,KAAqB,GAArB,IAA4BpB,KAAKqB,QAAL,KAAkB,CAA9C,IAAmD,GAAnD,GAAyDrB,KAAKsB,OAAL,EAAzE;AACA,YAAMC,UAAUvB,KAAKwB,QAAL,KAAkB,GAAlB,GAAwBxB,KAAKyB,UAAL,EAAxB,GAA4C,GAA5C,GAAkDzB,KAAK0B,UAAL,EAAlE;AACD,aAAK1C,IAAL,CAAU,gBAAV,EAA4BR,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACsB,UAASY,KAAV,EAAjB,EAAkC,EAACtB,OAAMA,KAAP,EAAlC,EAAgD,EAACsC,MAAK,CAAN,EAAhD,CAA5B;AACAtG,mBAAasF,MAAM9C,KAAnB,EAA0BmB,IAA1B,CAA+B,gBAA/B,EAAiDR,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACsB,UAASa,KAAV,EAAjB,EAAkC,EAACiB,OAAMA,KAAP,EAAlC,EAAgD,EAAC7B,MAAKmB,OAAN,EAAhD,EAA+D,EAAClB,MAAKsB,OAAN,EAA/D,EAA8E,EAACI,MAAK,CAAN,EAA9E,EAAuF,EAACnF,MAAK,YAAN,EAAvF,CAAjD;AACA;AACAnB,mBAAasF,MAAM9C,KAAnB,EAA0BkB,IAA1B,CAA+B8C,MAAMlF,QAArC;AApBsB;AAqBtB;;AAEKqF,qBAAN,GAA4B;AAAA;;AAAA;AAC3B;AACA;AACA;AACA,YAAMH,QAAQ,OAAKtD,MAAL,CAAYsD,KAA1B;;AAEAxG,mBAAawG,MAAMI,MAAnB,EAA2BjD,IAA3B,CAAgC,WAAhC,EAA4C,OAAKT,MAAjD;AACA;AAP2B;AAQ3B;;AAEK2D,oCAAN,GAA2C;AAAA;;AAAA;AAC1C;AACA,YAAMvB,QAAQ,QAAKpC,MAAL,CAAYoC,KAA1B;AACA,YAAMC,QAAQ,QAAKrC,MAAL,CAAYqC,KAA1B;AACA,YAAMiB,QAAQ,QAAKtD,MAAL,CAAYsD,KAA1B;AACA,YAAMxC,QAAQ,QAAKd,MAAL,CAAYc,KAA1B;;AAIA;AACAhE,mBAAawG,MAAMI,MAAnB,EAA2BjD,IAA3B,CAAgC,cAAhC,EAA+CR,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACsB,UAASY,KAAV,EAAjB,EAAkC,EAACkB,OAAMA,KAAP,EAAlC,EAAgD,EAACxC,OAAMA,KAAP,EAAhD,EAA8D,EAACsC,MAAK,CAAN,EAA9D,CAA/C;AACA;AACA,YAAM3B,OAAO,IAAIkB,IAAJ,EAAb;AACC,YAAMC,UAAUnB,KAAKoB,WAAL,KAAqB,GAArB,IAA4BpB,KAAKqB,QAAL,KAAkB,CAA9C,IAAmD,GAAnD,GAAyDrB,KAAKsB,OAAL,EAAzE;AACA,YAAMC,UAAUvB,KAAKwB,QAAL,KAAkB,GAAlB,GAAwBxB,KAAKyB,UAAL,EAAxB,GAA4C,GAA5C,GAAkDzB,KAAK0B,UAAL,EAAlE;AACDrG,mBAAauF,MAAME,YAAnB,EAAiC9B,IAAjC,CAAsC,cAAtC,EAAqDR,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACsB,UAASY,KAAV,EAAjB,EAAkC,EAACC,OAAMA,KAAP,EAAlC,EAAgD,EAACiB,OAAMA,KAAP,EAAhD,EAA8D,EAAC7B,MAAKmB,OAAN,EAA9D,EAA6E,EAAClB,MAAKsB,OAAN,EAA7E,EAA4F,EAACI,MAAK,CAAN,EAA5F,CAArD;AACA;AACA;AAjB0C;AAkB1C;;AAEKQ,8BAAN,GAAqC;AAAA;;AAAA;AACpC;AACA,YAAMxB,QAAQ,QAAKpC,MAAL,CAAYoC,KAA1B;AACA,YAAMC,QAAQ,QAAKrC,MAAL,CAAYqC,KAA1B;AACA,YAAMiB,QAAQ,QAAKtD,MAAL,CAAYsD,KAA1B;AACA,YAAMxC,QAAQ,QAAKd,MAAL,CAAYc,KAA1B;AACA3D,cAAQC,GAAR,CAAYiF,KAAZ;;AAEA,YAAMjC,KAAK,MAAM,QAAKlC,KAAL,CAAW,cAAX,EAA2BiE,GAA3B,CAA+B,IAA/B,CAAjB;AACA,YAAMlE,OAAO,MAAM,QAAKC,KAAL,CAAW,cAAX,EAA2BqF,GAA3B,CAA+B,EAACnD,IAAGA,KAAG,CAAP,EAASpC,YAAWqE,MAAME,YAA1B,EAAuCnE,UAASkF,MAAMlD,EAAtD,EAA/B,CAAnB;;AAEAtD,mBAAauF,MAAME,YAAnB,EAAiC9B,IAAjC,CAAsC,cAAtC,EAAqDR,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACsB,UAASY,KAAV,EAAjB,EAAkC,EAACkB,OAAMA,KAAP,EAAlC,EAAgD,EAACxC,OAAMA,KAAP,EAAhD,EAA8D,EAACsC,MAAK,CAAN,EAA9D,CAArD;AACA,YAAM3B,OAAO,IAAIkB,IAAJ,EAAb;AACC,YAAMC,UAAUnB,KAAKoB,WAAL,KAAqB,GAArB,IAA4BpB,KAAKqB,QAAL,KAAkB,CAA9C,IAAmD,GAAnD,GAAyDrB,KAAKsB,OAAL,EAAzE;AACA,YAAMC,UAAUvB,KAAKwB,QAAL,KAAkB,GAAlB,GAAwBxB,KAAKyB,UAAL,EAAxB,GAA4C,GAA5C,GAAkDzB,KAAK0B,UAAL,EAAlE;AACDrG,mBAAasF,MAAM9C,KAAnB,EAA0BmB,IAA1B,CAA+B,cAA/B,EAA8CR,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACsB,UAASY,KAAV,EAAjB,EAAkC,EAACkB,OAAMA,KAAP,EAAlC,EAAgD,EAACjB,OAAMA,KAAP,EAAhD,EAA8D,EAACX,MAAKsB,OAAN,EAA9D,EAA6E,EAACvB,MAAKmB,OAAN,EAA7E,EAA4F,EAACQ,MAAK,CAAN,EAA5F,EAAqG,EAACnF,MAAK,aAAN,EAArG,CAA9C;AACA;AACAnB,mBAAauF,MAAME,YAAnB,EAAiC/B,IAAjC,CAAsC8C,MAAMlD,EAA5C;AAjBoC;AAkBpC;;AAEKyD,uBAAN,GAA8B;AAAA;;AAAA;AAC7B,YAAMP,QAAQ,QAAKtD,MAAnB;AACA7C,cAAQC,GAAR,CAAa,OAAMkG,MAAMpG,MAAN,CAAa,CAAb,EAAgBkB,QAAS,EAA5C;AACA,cAAK+B,SAAL,CAAeK,IAAf,CAAoB8C,MAAMpG,MAAN,CAAa,CAAb,EAAgBkB,QAApC;AAH6B;AAI7B;;AAEK0F,mBAAN,GAA0B;AAAA;;AAAA;AACzB,YAAM1F,WAAW,QAAK4B,MAAL,CAAYsD,KAAZ,CAAkBlD,EAAnC;AACA,cAAKwB,GAAL,CAASC,GAAT,CAAa1B,SAAb,CAAuB2B,EAAvB,CAA0BC,EAA1B,CAA6B3D,QAA7B,EAAuCqC,IAAvC,CAA4C,aAA5C,EAA2D,QAAKT,MAAhE;AACA,YAAM+D,UAAU,MAAM,QAAK7F,KAAL,CAAW,cAAX,EAA2BC,KAA3B,CAAiC,EAACC,UAASA,QAAV,EAAjC,EAAsDC,MAAtD,EAAtB;AACA,YAAM0F,QAAQzD,GAAR,CAAY,UAACC,CAAD,EAAO;AACvB,YAAGzD,aAAayD,EAAEvC,UAAf,CAAH,EACClB,aAAayD,EAAEvC,UAAf,EAA2BgG,KAA3B,CAAiC5F,QAAjC;AACF,OAHK,CAAN;AAIA,YAAM,QAAKF,KAAL,CAAW,cAAX,EAA2BC,KAA3B,CAAiC,EAACC,UAASA,QAAV,EAAjC,EAAsD6F,MAAtD,EAAN;AACA,YAAM,QAAK/F,KAAL,CAAW,OAAX,EAAoBC,KAApB,CAA0B,EAACC,UAASA,QAAV,EAA1B,EAA+C6F,MAA/C,EAAN;AATyB;AAUzB;;AAEKC,kBAAN,GAAyB;AAAA;;AAAA;AACxB,YAAM9F,WAAW,QAAK4B,MAAL,CAAYsD,KAAZ,CAAkBlD,EAAnC;AACA,cAAKD,SAAL,CAAe6D,KAAf,CAAqB5F,QAArB;AAFwB;AAGxB;AA/SiC,CAApC",
    "file": "..\\..\\..\\src\\api\\controller\\websocket.js",
    "sourcesContent": [
        "const Base = require('./base.js');\r\nimport amqp from 'amqplib/callback_api';\r\nconst socketObject = {}\r\nlet conn = ''\r\nconnectmq().then((result) => {\r\n      conn = result\r\n      console.log('连接上mq')\r\n    }).catch((error) => console.log(error))\r\n\r\nfunction connectmq() {\r\n    return new Promise((resolve,reject) => {\r\n      amqp.connect('amqp://localhost', function (err, conn) {\r\n        if(err)\r\n          reject(err)\r\n        else\r\n          resolve(conn)\r\n       });\r\n    })\r\n  }\r\n// this.websocket是指客户端的socket\r\n// this就是this.websocket\r\n// 所有的socket怎么得？\r\n// 不用获得所有socket的方法是将每个连上的socket放入socketMap\r\n// 发送数据到别的客户端可以用this.websocket.emit\r\nmodule.exports = class extends Base {\r\n\r\n  async findGroups(user_email) {\r\n  \tconst data = await this.model('relationship').where({user_email:user_email,group_id:['!=',null]}).select()\r\n  \treturn data\r\n  }\r\n\r\n\r\n  /*\r\n    data: {\r\n      sendObj: {\r\n        id: 'toemail',\r\n        data: [\r\n        {\r\n          fromUser: {\r\n            user_email: '',\r\n            user_name: '',\r\n            avatar: '',\r\n          },\r\n          data: '',\r\n          date: '',\r\n          time: '',\r\n          isOnline: true || false,\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  */\r\n  async assertmq(data,to) {\r\n    await conn.createChannel((err, channel) => {\r\n\r\n      const q = to;\r\n\r\n      channel.assertQueue(q, { durable: true });\r\n      // Note: on Node 6 Buffer.from(msg) should be used\r\n      channel.sendToQueue(q, new Buffer(JSON.stringify(data)), { persistent: true });\r\n      console.log(data);\r\n      channel.close()\r\n    });\r\n  }\r\n\r\n  async createmqchannel() {\r\n    return new Promise((resolve,reject) => {\r\n      conn.createChannel((err,ch) => {\r\n        // if(err)\r\n        //   reject(err)\r\n        // else\r\n          resolve(ch)\r\n      })\r\n    })\r\n  }\r\n \r\n\r\n\r\n  async receivemq(email) {\r\n    const channel = await this.createmqchannel()\r\n    if(think.isEmpty(channel))\r\n      return\r\n\r\n    return new Promise((resolve,reject) => {\r\n      const q = email\r\n      channel.checkQueue(q)\r\n        channel.assertQueue(q, {durable: true});\r\n        channel.consume(q, (data) => {\r\n          channel.ack(data);\r\n          resolve(JSON.parse(data.content))\r\n        }, {noAck: false});\r\n        channel.close()\r\n    })\r\n  }\r\n\r\n\r\n  async loginAction() {\r\n  \t// 获取用户邮箱\r\n    const email = this.wsData.email\r\n  \t// const user = await this.session('user_token');\r\n  \t/*if(think.isEmpty(user)){\r\n      return ;\r\n    }*/\r\n  \tconsole.log('user email: ' + email)\r\n\r\n  \t// 写入对象，email对应socket本身\r\n  \tObject.assign(socketObject, {[email]:this.websocket})\r\n\r\n  \tconsole.log(`socketId: ${this.websocket.id}连接`)\r\n  \t// this.emit('opend', 'This client opened successfully!')\r\n  \tconst groups = await this.findGroups(email)\r\n  \tgroups.map((n) => {\r\n  \t  this.websocket.join(n.group_id);\r\n  \t})\r\n  \t\r\n  \tawait this.receivemq(email)\r\n    .then(resolve => {\r\n      console.log(resolve)\r\n      this.emit('message', {sendObj:resolve} )\r\n    })\r\n    .catch(reject => console.log('error'))\r\n    // console.log(msg)\r\n  }\r\n\r\n  async closeAction() {\r\n    const emails = Object.keys(socketObject)\r\n    const index = emails.findIndex((value) => Object.is(socketObject[value],this.websocket))\r\n    if(index !== -1) {\r\n      console.log(`${emails[index]}关闭`)\r\n      Object.assign(socketObject,{[emails[index]]:undefined})\r\n    }\r\n  }\r\n\r\n\r\n  async chatAction() {\r\n  \t// 要发送的信息\r\n  \t// 离线消息放入redis？\r\n//   \tconst sseett = [1,2,{aa:'12'}]\r\n//   \tawait think.cache('aaa', sseett);\r\n//   \tlet aaa = await think.cache('aaa');\r\n//   \tconsole.log(aaa)\r\n//   \tsseett.push({aa:'13'})\r\n//   \tawait think.cache('aaa', sseett);\r\n// aaa = await think.cache('aaa');\r\n  \t// await think.cache('aaa').then((data)=> {\r\n  \t//   console.log(data)\r\n  \t// })\r\n  // \tif(this.wsData.file) {\r\n  // \t  var myArray = new ArrayBuffer(512);\r\n\t //  var longInt8View = new Uint8Array(myArray);\r\n\t //  for (var i=0; i< longInt8View.length; i++) {\r\n\t\t// longInt8View[i] = i % 255;\r\n\t //  }\r\n  // \t}\r\n  \tlet to = ''\r\n  \tif(this.wsData.sendTo.toUser) {\r\n  \t  to = this.wsData.sendTo.toUser.email\r\n  \t  // if(socketObject[to]) {\r\n  \t  \tconst sendObj = {}\r\n  \t  \tconst data = []\r\n  \t  \tdata.push({\r\n  \t  \t  isOnline: true,\r\n  \t  \t  fromUser: this.wsData.fromUser,\r\n  \t  \t  data: this.wsData.data,\r\n  \t  \t  date: this.wsData.date,\r\n  \t  \t  time: this.wsData.time,\r\n  \t  \t  // file: this.wsData.file,\r\n  \t  \t})\r\n  \t  \tObject.assign(sendObj,{id:to},{data:data})\r\n  \t  \tthis.emit('message',{sendObj})\r\n  \t  \tObject.assign(sendObj,{id:this.wsData.fromUser.email})\r\n        console.log(think.isEmpty(socketObject[to]))\r\n        if(think.isEmpty(socketObject[to])) {\r\n          // 未在线 将数据放mq\r\n          this.assertmq(sendObj,to)\r\n          return\r\n        }\r\n  \t  \tsocketObject[to].emit('message', {sendObj} )\r\n  \t  // }\r\n  \t}\r\n  \telse {\r\n  \t  to = this.wsData.sendTo.toGroup.id\r\n  \t  // if(socketObject[to]) {\r\n  \t  \tconst sendObj = {}\r\n  \t  \tconst data = []\r\n  \t  \tdata.push({\r\n  \t  \t  isOnline: 1,\r\n  \t  \t  fromUser: this.wsData.fromUser,\r\n  \t  \t  data: this.wsData.data,\r\n  \t  \t  date: this.wsData.date,\r\n  \t  \t  time: this.wsData.time,\r\n  \t  \t})\r\n  \t  \tObject.assign(sendObj,{id:to},{data:data})\r\n  \t  \tthis.ctx.app.websocket.io.in(to).emit('message', {sendObj});\r\n  \t  // }\r\n  \t}\r\n  }\r\n\r\n  async addVerifyAction() {\r\n  \t// 收到好友/群组验证\r\n  \tconsole.log('`${this.wsData.fromUser.email}`发出验证数据')\r\n  \tsocketObject[this.wsData.toEmail].emit('getVerify', this.wsData)\r\n  \t// this.emit('getVerify', this.wsData)\r\n  }\r\n\r\n  async addFriendAction() {\r\n    const id = await this.model('relationship').max('id')\r\n    // userA 邀请方\r\n    const userA = this.wsData.userA\r\n    const userB = this.wsData.userB\r\n    const a = Object.assign({},{id:id+1},{user_email:userA.email},{friend_email:userB.email})\r\n    const b = Object.assign({},{id:id+2},{user_email:userB.email},{friend_email:userA.email})\r\n    console.log([a,b])\r\n    const data = await this.model('relationship').addMany([a,b])\r\n\r\n    // 有历史记录\r\n    // 验证信息将变为系统消息\r\n    // const systemMessage = user\r\n    // fs.writeFileSync\r\n    if(data.length < 2) {\r\n      // 回滚\r\n      return false\r\n    }\r\n    // 好友成功\r\n    // this是接受方\r\n    const index = this.wsData.index\r\n    const date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n    this.emit('addFriendResult', Object.assign({},{fromUser:userA},{index:index},{type:3}))\r\n    socketObject[userA.email].emit('addFriendResult', Object.assign({},{fromUser:userB},{date:dateStr},{time:timeStr},{type:0},{data:'接受了您的添加请求并添加您为好友'}))\r\n  }\r\n\r\n  async addGroupAction() {\r\n  \tconst id = await this.model('relationship').max('id')\r\n  \t// userA 申请方\r\n  \t// userB 接受方\r\n  \tconst userA = this.wsData.userA\r\n  \tconst userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n  \tconst data = await this.model('relationship').add({id:id+1,user_email:userA.email,group_id:group.group_id})\r\n  \tconst dataisExist = await this.model('relationship').where({id:id+1}).select()\r\n  \tconsole.log(dataisExist)\r\n  \tif(dataisExist.length <=0)\r\n  \t  return false\r\n\r\n  \tconst index = this.wsData.index\r\n  \tconst date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n  \tthis.emit('addGroupResult', Object.assign({},{fromUser:userA},{index:index},{type:4}))\r\n  \tsocketObject[userA.email].emit('addGroupResult', Object.assign({},{fromUser:userB},{group:group},{date:dateStr},{time:timeStr},{type:0},{data:'接受了您加入群的请求'}))\r\n  \t// join group\r\n  \tsocketObject[userA.email].join(group.group_id);\r\n  }\r\n\r\n  async inviteToGroupAction() {\r\n  \t// userA 发起邀请方\r\n  \t// const userA = this.wsData.userA\r\n  \t// const userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n\r\n  \tsocketObject[group.leader].emit('getVerify',this.wsData)\r\n  \t// socketObject[group.leader].emit(...)\r\n  }\r\n\r\n  async acceptInviteAddToGroupLeaderAction() {\r\n  \t// userA 发起邀请方\r\n  \tconst userA = this.wsData.userA\r\n  \tconst userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n  \tconst index = this.wsData.index\r\n\r\n  \t\r\n  \t\r\n  \t// fromUser是邀请方\r\n  \tsocketObject[group.leader].emit('inviteResult',Object.assign({},{fromUser:userA},{group:group},{index:index},{type:6}))\r\n  \t// 发给userA fromUser是userB userB接受邀请 写data\r\n  \tconst date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n  \tsocketObject[userB.friend_email].emit('inviteResult',Object.assign({},{fromUser:userA},{userB:userB},{group:group},{date:dateStr},{time:timeStr},{type:5}))\r\n  \t// join group\r\n  \t// this.websocket.join(group.id);\r\n  }\r\n\r\n  async acceptInviteAddToGroupAction() {\r\n  \t// userA 发起邀请方\r\n  \tconst userA = this.wsData.userA\r\n  \tconst userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n  \tconst index = this.wsData.index\r\n  \tconsole.log(userB)\r\n\r\n  \tconst id = await this.model('relationship').max('id')\r\n  \tconst data = await this.model('relationship').add({id:id+1,user_email:userB.friend_email,group_id:group.id})\r\n\r\n  \tsocketObject[userB.friend_email].emit('inviteResult',Object.assign({},{fromUser:userA},{group:group},{index:index},{type:6}))\r\n  \tconst date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n  \tsocketObject[userA.email].emit('inviteResult',Object.assign({},{fromUser:userA},{group:group},{userB:userB},{time:timeStr},{date:dateStr},{type:7},{data:'接受了您的请求并加入群'}))\r\n  \t// join group\r\n  \tsocketObject[userB.friend_email].join(group.id);\r\n  }\r\n\r\n  async createGroupJoinAction() {\r\n  \tconst group = this.wsData\r\n  \tconsole.log(`进入房间${group.result[0].group_id}`)\r\n  \tthis.websocket.join(group.result[0].group_id)\r\n  }\r\n\r\n  async removeGroupAction() {\r\n  \tconst group_id = this.wsData.group.id\r\n  \tthis.ctx.app.websocket.io.in(group_id).emit('removeGroup', this.wsData);\r\n  \tconst members = await this.model('relationship').where({group_id:group_id}).select()\r\n  \tawait members.map((n) => {\r\n  \t  if(socketObject[n.user_email])\r\n  \t  \tsocketObject[n.user_email].leave(group_id)\r\n  \t})\r\n  \tawait this.model('relationship').where({group_id:group_id}).delete()\r\n  \tawait this.model('group').where({group_id:group_id}).delete()\r\n  }\r\n\r\n  async leaveGroupAction() {\r\n  \tconst group_id = this.wsData.group.id\r\n  \tthis.websocket.leave(group_id)\r\n  }\r\n};\r\n"
    ]
}
{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\controller\\websocket.js"
    ],
    "names": [
        "Base",
        "require",
        "socketObject",
        "conn",
        "connectmq",
        "then",
        "result",
        "console",
        "log",
        "catch",
        "error",
        "Promise",
        "resolve",
        "reject",
        "amqp",
        "connect",
        "err",
        "module",
        "exports",
        "findGroups",
        "user_email",
        "data",
        "model",
        "where",
        "group_id",
        "select",
        "assertmq",
        "to",
        "createChannel",
        "channel",
        "q",
        "assertQueue",
        "durable",
        "sendToQueue",
        "Buffer",
        "JSON",
        "stringify",
        "persistent",
        "close",
        "createmqchannel",
        "ch",
        "receivemq",
        "email",
        "checkQueue",
        "promise",
        "consume",
        "parse",
        "content",
        "toString",
        "sendObj",
        "emit",
        "noAck",
        "setTimeout",
        "loginAction",
        "wsData",
        "Object",
        "assign",
        "websocket",
        "id",
        "groups",
        "map",
        "n",
        "join",
        "think",
        "isEmpty",
        "closeAction",
        "emails",
        "keys",
        "index",
        "findIndex",
        "value",
        "is",
        "undefined",
        "chatAction",
        "sendTo",
        "toUser",
        "push",
        "isOnline",
        "fromUser",
        "date",
        "time",
        "toGroup",
        "ctx",
        "app",
        "io",
        "in",
        "members",
        "field",
        "addVerifyAction",
        "toEmail",
        "addFriendAction",
        "max",
        "userA",
        "userB",
        "a",
        "friend_email",
        "b",
        "addMany",
        "length",
        "Date",
        "dateStr",
        "getFullYear",
        "getMonth",
        "getDate",
        "timeStr",
        "getHours",
        "getMinutes",
        "getSeconds",
        "type",
        "addGroupAction",
        "group",
        "add",
        "dataisExist",
        "inviteToGroupAction",
        "leader",
        "acceptInviteAddToGroupLeaderAction",
        "acceptInviteAddToGroupAction",
        "createGroupJoinAction",
        "removeGroupAction",
        "leave",
        "delete",
        "leaveGroupAction"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\api\\controller\\websocket.js",
    "sourcesContent": [
        "const Base = require('./base.js');\r\nimport amqp from 'amqplib/callback_api';\r\nconst socketObject = {}\r\nlet conn = ''\r\nconnectmq().then((result) => {\r\n      conn = result\r\n      console.log('连接上mq')\r\n    }).catch((error) => console.log(error))\r\n\r\nfunction connectmq() {\r\n    return new Promise((resolve,reject) => {\r\n      amqp.connect('amqp://localhost', function (err, conn) {\r\n        if(err)\r\n          reject(err)\r\n        else\r\n          resolve(conn)\r\n       });\r\n    })\r\n  }\r\n// this.websocket是指客户端的socket\r\n// this就是this.websocket\r\n// 所有的socket怎么得？\r\n// 不用获得所有socket的方法是将每个连上的socket放入socketMap\r\n// 发送数据到别的客户端可以用this.websocket.emit\r\nmodule.exports = class extends Base {\r\n\r\n  async findGroups(user_email) {\r\n  \tconst data = await this.model('relationship').where({user_email:user_email,group_id:['!=',null]}).select()\r\n  \treturn data\r\n  }\r\n\r\n\r\n  /*\r\n    data: {\r\n      sendObj: {\r\n        id: 'toemail',\r\n        data: [\r\n        {\r\n          fromUser: {\r\n            user_email: '',\r\n            user_name: '',\r\n            avatar: '',\r\n          },\r\n          data: '',\r\n          date: '',\r\n          time: '',\r\n          isOnline: true || false,\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  */\r\n  async assertmq(data,to) {\r\n    await conn.createChannel((err, channel) => {\r\n\r\n      const q = to;\r\n\r\n      channel.assertQueue(q, { durable: true });\r\n      // Note: on Node 6 Buffer.from(msg) should be used\r\n      channel.sendToQueue(q, new Buffer(JSON.stringify(data)), { persistent: true });\r\n      console.log(data);\r\n      channel.close()\r\n    });\r\n  }\r\n\r\n  async createmqchannel() {\r\n    return new Promise((resolve,reject) => {\r\n      conn.createChannel((err,ch) => {\r\n        // if(err)\r\n        //   reject(err)\r\n        // else\r\n          resolve(ch)\r\n      })\r\n    })\r\n  }\r\n \r\n  // async consumemq() {\r\n  //   return new Promise((resolve,reject) => {\r\n  //     channel.consume(q, (msg) => {\r\n  //       // console.log(JSON.parse(data.content.toString()))\r\n  //       // msg.push(JSON.parse(data.content.toString()))\r\n  //       resolve(msg)\r\n  //       // channel.ack(data);\r\n  //     }, {noAck: false});\r\n  //   })\r\n  // }\r\n\r\n  async receivemq(email,channel) {\r\n    // const channel = await this.createmqchannel()\r\n    // if(think.isEmpty(channel))\r\n    //   return\r\n      const q = email\r\n      console.log(q)\r\n      channel.checkQueue(q)\r\n      channel.assertQueue(q, {durable: true});\r\n    const promise = new Promise((resolve,reject) => {\r\n      // const msg = []\r\n      //channel.prefetch(1)\r\n      channel.consume(q, (data) => {\r\n        console.log(JSON.parse(data.content.toString()))\r\n        const sendObj = JSON.parse(data.content.toString())\r\n        this.emit('message', {sendObj})\r\n        // msg.push(JSON.parse(data.content.toString()))\r\n        resolve(JSON.parse(data.content.toString()))\r\n        // channel.ack(data);\r\n      }, {noAck: true});\r\n    })\r\n    setTimeout(()=> {\r\n      channel.close()\r\n    },1000*10)\r\n    //return promise\r\n  }\r\n\r\n\r\n  async loginAction() {\r\n  \t// 获取用户邮箱\r\n    const email = this.wsData.email\r\n  \tconsole.log('user email: ' + email)\r\n\r\n  \t// 写入对象，email对应socket本身\r\n  \tObject.assign(socketObject, {[email]:this.websocket})\r\n\r\n  \tconsole.log(`socketId: ${this.websocket.id}连接`)\r\n  \tconst groups = await this.findGroups(email)\r\n  \tgroups.map((n) => {\r\n  \t  this.websocket.join(n.group_id);\r\n  \t})\r\n\r\n  \tconst channel = await this.createmqchannel();\r\n    if(think.isEmpty(channel))\r\n      return\r\n\r\n  \t// let msg = [1]\r\n    // while(!think.isEmpty(msg)) {\r\n      // msg = []\r\n      this.receivemq(email,channel)\r\n     // console.log(think.isEmpty(msg)+'aaaaaa')\r\n      // let sendObj = msg\r\n      // this.emit('message', {sendObj})\r\n    // }\r\n    // channel.close()\r\n    \r\n  }\r\n\r\n  async closeAction() {\r\n    const emails = Object.keys(socketObject)\r\n    const index = emails.findIndex((value) => Object.is(socketObject[value],this.websocket))\r\n    if(index !== -1) {\r\n      console.log(`${emails[index]}关闭`)\r\n      Object.assign(socketObject,{[emails[index]]:undefined})\r\n    }\r\n  }\r\n\r\n\r\n  async chatAction() {\r\n  \t// 要发送的信息\r\n  \t// 离线消息放入redis？\r\n//   \tconst sseett = [1,2,{aa:'12'}]\r\n//   \tawait think.cache('aaa', sseett);\r\n//   \tlet aaa = await think.cache('aaa');\r\n//   \tconsole.log(aaa)\r\n//   \tsseett.push({aa:'13'})\r\n//   \tawait think.cache('aaa', sseett);\r\n// aaa = await think.cache('aaa');\r\n  \t// await think.cache('aaa').then((data)=> {\r\n  \t//   console.log(data)\r\n  \t// })\r\n  // \tif(this.wsData.file) {\r\n  // \t  var myArray = new ArrayBuffer(512);\r\n\t //  var longInt8View = new Uint8Array(myArray);\r\n\t //  for (var i=0; i< longInt8View.length; i++) {\r\n\t\t// longInt8View[i] = i % 255;\r\n\t //  }\r\n  // \t}\r\n  \tlet to = ''\r\n  \tif(this.wsData.sendTo.toUser) {\r\n  \t  to = this.wsData.sendTo.toUser.email\r\n  \t  // if(socketObject[to]) {\r\n  \t  \tconst sendObj = {}\r\n  \t  \tconst data = []\r\n  \t  \tdata.push({\r\n  \t  \t  isOnline: true,\r\n  \t  \t  fromUser: this.wsData.fromUser,\r\n  \t  \t  data: this.wsData.data,\r\n  \t  \t  date: this.wsData.date,\r\n  \t  \t  time: this.wsData.time,\r\n  \t  \t  // file: this.wsData.file,\r\n  \t  \t})\r\n  \t  \tObject.assign(sendObj,{id:to},{data:data})\r\n  \t  \tthis.emit('message',{sendObj})\r\n  \t  \tObject.assign(sendObj,{id:this.wsData.fromUser.email})\r\n        console.log(think.isEmpty(socketObject[to]))\r\n        if(socketObject[to] === undefined) {\r\n          // 未在线 将数据放mq\r\n          console.log('fang mq')\r\n          this.assertmq(sendObj,to)\r\n          return\r\n        }\r\n  \t  \tsocketObject[to].emit('message', {sendObj} )\r\n  \t  // }\r\n  \t}\r\n  \telse {\r\n  \t  to = this.wsData.sendTo.toGroup.id\r\n  \t  // if(socketObject[to]) {\r\n  \t  \tconst sendObj = {}\r\n  \t  \tconst data = []\r\n  \t  \tdata.push({\r\n  \t  \t  isOnline: 1,\r\n  \t  \t  fromUser: this.wsData.fromUser,\r\n  \t  \t  data: this.wsData.data,\r\n  \t  \t  date: this.wsData.date,\r\n  \t  \t  time: this.wsData.time,\r\n  \t  \t})\r\n  \t  \tObject.assign(sendObj,{id:to},{data:data})\r\n  \t  \tthis.ctx.app.websocket.io.in(to).emit('message', {sendObj});\r\n\r\n        const members = await this.model('relationship').where({group_id:to}).field('user_email').select()\r\n        members.map((n) => {\r\n          if(think.isEmpty(socketObject[n.user_email])) {\r\n            this.assertmq(sendObj,n.user_email)\r\n          }\r\n        })\r\n  \t  \r\n  \t}\r\n  }\r\n\r\n  async addVerifyAction() {\r\n  \t// 收到好友/群组验证\r\n  \tconsole.log('`${this.wsData.fromUser.email}`发出验证数据')\r\n  \tsocketObject[this.wsData.toEmail].emit('getVerify', this.wsData)\r\n  \t// this.emit('getVerify', this.wsData)\r\n  }\r\n\r\n  async addFriendAction() {\r\n    const id = await this.model('relationship').max('id')\r\n    // userA 邀请方\r\n    const userA = this.wsData.userA\r\n    const userB = this.wsData.userB\r\n    const a = Object.assign({},{id:id+1},{user_email:userA.email},{friend_email:userB.email})\r\n    const b = Object.assign({},{id:id+2},{user_email:userB.email},{friend_email:userA.email})\r\n    console.log([a,b])\r\n    const data = await this.model('relationship').addMany([a,b])\r\n\r\n    // 有历史记录\r\n    // 验证信息将变为系统消息\r\n    // const systemMessage = user\r\n    // fs.writeFileSync\r\n    if(data.length < 2) {\r\n      // 回滚\r\n      return false\r\n    }\r\n    // 好友成功\r\n    // this是接受方\r\n    const index = this.wsData.index\r\n    const date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n    this.emit('addFriendResult', Object.assign({},{fromUser:userA},{index:index},{type:3}))\r\n    socketObject[userA.email].emit('addFriendResult', Object.assign({},{fromUser:userB},{date:dateStr},{time:timeStr},{type:0},{data:'接受了您的添加请求并添加您为好友'}))\r\n  }\r\n\r\n  async addGroupAction() {\r\n  \tconst id = await this.model('relationship').max('id')\r\n  \t// userA 申请方\r\n  \t// userB 接受方\r\n  \tconst userA = this.wsData.userA\r\n  \tconst userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n  \tconst data = await this.model('relationship').add({id:id+1,user_email:userA.email,group_id:group.group_id})\r\n  \tconst dataisExist = await this.model('relationship').where({id:id+1}).select()\r\n  \tconsole.log(dataisExist)\r\n  \tif(dataisExist.length <=0)\r\n  \t  return false\r\n\r\n  \tconst index = this.wsData.index\r\n  \tconst date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n  \tthis.emit('addGroupResult', Object.assign({},{fromUser:userA},{index:index},{type:4}))\r\n  \tsocketObject[userA.email].emit('addGroupResult', Object.assign({},{fromUser:userB},{group:group},{date:dateStr},{time:timeStr},{type:0},{data:'接受了您加入群的请求'}))\r\n  \t// join group\r\n  \tsocketObject[userA.email].join(group.group_id);\r\n  }\r\n\r\n  async inviteToGroupAction() {\r\n  \t// userA 发起邀请方\r\n  \t// const userA = this.wsData.userA\r\n  \t// const userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n\r\n  \tsocketObject[group.leader].emit('getVerify',this.wsData)\r\n  \t// socketObject[group.leader].emit(...)\r\n  }\r\n\r\n  async acceptInviteAddToGroupLeaderAction() {\r\n  \t// userA 发起邀请方\r\n  \tconst userA = this.wsData.userA\r\n  \tconst userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n  \tconst index = this.wsData.index\r\n\r\n  \t\r\n  \t\r\n  \t// fromUser是邀请方\r\n  \tsocketObject[group.leader].emit('inviteResult',Object.assign({},{fromUser:userA},{group:group},{index:index},{type:6}))\r\n  \t// 发给userA fromUser是userB userB接受邀请 写data\r\n  \tconst date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n  \tsocketObject[userB.friend_email].emit('inviteResult',Object.assign({},{fromUser:userA},{userB:userB},{group:group},{date:dateStr},{time:timeStr},{type:5}))\r\n  \t// join group\r\n  \t// this.websocket.join(group.id);\r\n  }\r\n\r\n  async acceptInviteAddToGroupAction() {\r\n  \t// userA 发起邀请方\r\n  \tconst userA = this.wsData.userA\r\n  \tconst userB = this.wsData.userB\r\n  \tconst group = this.wsData.group\r\n  \tconst index = this.wsData.index\r\n  \tconsole.log(userB)\r\n\r\n  \tconst id = await this.model('relationship').max('id')\r\n  \tconst data = await this.model('relationship').add({id:id+1,user_email:userB.friend_email,group_id:group.id})\r\n\r\n  \tsocketObject[userB.friend_email].emit('inviteResult',Object.assign({},{fromUser:userA},{group:group},{index:index},{type:6}))\r\n  \tconst date = new Date()\r\n    const dateStr = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()\r\n    const timeStr = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()\r\n  \tsocketObject[userA.email].emit('inviteResult',Object.assign({},{fromUser:userA},{group:group},{userB:userB},{time:timeStr},{date:dateStr},{type:7},{data:'接受了您的请求并加入群'}))\r\n  \t// join group\r\n  \tsocketObject[userB.friend_email].join(group.id);\r\n  }\r\n\r\n  async createGroupJoinAction() {\r\n  \tconst group = this.wsData\r\n  \tconsole.log(`进入房间${group.result[0].group_id}`)\r\n  \tthis.websocket.join(group.result[0].group_id)\r\n  }\r\n\r\n  async removeGroupAction() {\r\n  \tconst group_id = this.wsData.group.id\r\n  \tthis.ctx.app.websocket.io.in(group_id).emit('removeGroup', this.wsData);\r\n  \tconst members = await this.model('relationship').where({group_id:group_id}).select()\r\n  \tawait members.map((n) => {\r\n  \t  if(socketObject[n.user_email])\r\n  \t  \tsocketObject[n.user_email].leave(group_id)\r\n  \t})\r\n  \tawait this.model('relationship').where({group_id:group_id}).delete()\r\n  \tawait this.model('group').where({group_id:group_id}).delete()\r\n  }\r\n\r\n  async leaveGroupAction() {\r\n  \tconst group_id = this.wsData.group.id\r\n  \tthis.websocket.leave(group_id)\r\n  }\r\n};\r\n"
    ]
}